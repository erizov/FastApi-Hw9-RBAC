# 08 Авторизация и защита приватных маршрутов

## Описание темы  

В теме рассматривается реализация авторизации и механизмов защиты приватных маршрутов в приложениях на FastAPI. Подробно разбирается, как проверять права доступа пользователей на основе ролей и токенов, ограничивать использование API для неавторизованных клиентов и реализовать логику разграничения привилегий (например, администратор, менеджер, клиент).  

Обсуждаются практические аспекты использования зависимостей FastAPI (`Depends`), интеграции проверки токена JWT при каждом запросе, а также создание middleware для централизованной защиты маршрутов.  

Отдельное внимание уделяется взаимодействию с нейроконсультантом интернет-магазина — интеллектуальным помощником, который общается с клиентами, передаёт сложные запросы менеджеру и работает с персональными данными. Чтобы такая система функционировала безопасно, необходимо правильно разграничить права доступа: консультант должен видеть только ту информацию, которая разрешена для его уровня, а личные данные клиентов должны быть защищены на уровне API.  

## Цели освоения темы:  

1. Понять различия между аутентификацией и авторизацией и роль каждой из них в безопасности веб-приложений.  
2. Научиться защищать приватные маршруты и ограничивать доступ на уровне API.  
3. Освоить работу с зависимостями и middleware для централизованной проверки прав.  
4. Реализовать разграничение доступа на основе ролей пользователей (RBAC).  
5. Научиться применять эти принципы для защиты диалогов и данных нейроконсультанта интернет-магазина.  

## В результате освоения темы можно:  

1. Организовать защиту приватных маршрутов, доступных только авторизованным пользователям.  
2. Проверять JWT при каждом запросе и обрабатывать невалидные или просроченные токены.  
3. Использовать зависимости FastAPI для удобной проверки прав в контроллерах.  
4. Реализовать логику доступа к данным в зависимости от роли (админ, клиент, консультант и т.д.).  
5. Повысить безопасность API и исключить несанкционированный доступ к личным данным клиентов.  
6. Обеспечить безопасную работу нейроконсультанта интернет-магазина, чтобы он мог взаимодействовать с менеджерами и клиентами без нарушения правил доступа.  

## Место в курсе  

Данная тема продолжает модуль, посвящённый безопасности пользовательских данных. После изучения регистрации и логина в предыдущем уроке, теперь акцент делается на контроле прав и ограничении доступа к ресурсам. Это формирует основу защищённой архитектуры проекта, где каждый пользователь и агент (включая нейроконсультанта) получает доступ только к разрешённым функциям и маршрутам, обеспечивая надёжную защиту данных клиентов интернет-магазина.  

---

## Выполненные задачи

### Задача 9: Защита истории диалогов от просмотра другими пользователями

**Описание:**

Реализована защита истории диалогов, обеспечивающая доступ каждого
клиента только к своей истории общения с ассистентом. При попытке
доступа к чужому диалогу сервер возвращает ошибку `403 Forbidden`.

**Реализовано:**

1. **Проверка владельца диалога** (`app/routes/dialog.py`)
   - Добавлена зависимость `current_user = Depends(get_current_user)`
     во все защищённые маршруты
   - Реализована проверка прав доступа с учётом роли администратора:

   ```python
   if not current_user.is_admin and client_id != current_user.id:
       raise HTTPException(status_code=403,
                         detail="Доступ запрещён: чужой диалог")
   ```

2. **Защищённые эндпоинты:**
   - `GET /dialog/history/{client_id}` — получение истории диалога
   - `POST /dialog/request` — отправка сообщения в диалог
   - `POST /dialog/clear` — очистка истории диалога

3. **Логирование действий**
   - Успешный доступ к истории — `log_info` с данными пользователя
   - Попытка доступа к чужому диалогу — `log_warning` с указанием
     пользователя и целевого ID
   - Все логи включают информацию о пользователе и его роли

4. **Тестирование** (`app/test/dialog.ipynb`)
   - Авторизация трёх пользователей (admin, user1, user2)
   - Создание диалогов для каждого пользователя
   - Проверка доступа к собственной истории
   - Проверка защиты от доступа к чужим диалогам (403)
   - Проверка прав администратора (полный доступ)

**Результат:**

✅ **Обычный пользователь:**

- Видит только свой диалог
- Не может получить историю других пользователей
- Не может отправлять сообщения в чужие диалоги
- Не может очищать чужие диалоги

✅ **Администратор:**

- Имеет полный доступ ко всем диалогам
- Может просматривать любые истории
- Может управлять любыми диалогами

✅ **Сервер:**

- Логирует все попытки несанкционированного доступа
- Корректно возвращает ошибки `401` (невалидный токен)
  и `403` (чужой диалог)

**Файлы изменений:**

- `project/app/routes/dialog.py` — добавлена защита эндпоинтов
- `project/app/test/dialog.ipynb` — комплексное тестирование защиты
