# Домашнее задание: защита истории диалогов конкретного клиента

## Задача

Реализовать защиту истории диалогов от просмотра другими пользователями.
Каждый клиент должен иметь доступ **только к своей** истории общения с ассистентом.
Даже если клиент попытается вручную подставить `client_id` другого пользователя в URL — сервер должен вернуть ошибку `403 Forbidden`.

---

## Что нужно сделать

1. **Добавить проверку владельца диалога**
   В каждом защищённом маршруте (`/dialog/history/{client_id}`, `/dialog/request`, `/dialog/clear`) добавить зависимость:

   ```python
   current_user = Depends(get_current_user)
   ```

   и проверку:

   ```python
   if not current_user.is_admin and client_id != current_user.id:
       raise HTTPException(status_code=403, detail="Доступ запрещён: чужой диалог")
   ```

2. **Применить логику в эндпоинтах**

   * `/history/{client_id}` — получение истории
   * `/dialog/request` - запрос
   * `/clear` — очистка истории

   В них должна стоять проверка, что текущий пользователь обращается только к своей истории.

3. **Добавить логирование действий**
   Использовать `request.app.state.log` для записи событий:

   * успешный доступ к истории (`log_info`)
   * попытка доступа к чужому диалогу (`log_warning` или `log_error`)

4. **Проверить через Jupyter (файл `dialog.ipynb`)**

   * авторизоваться двумя пользователями;
   * выполнить несколько запросов `/dialog/request` и `/dialog/history/{id}`;
   * убедиться, что каждый пользователь видит **только свои** сообщения;
   * при попытке обратиться к чужому `client_id` возвращается `403 Forbidden`.

---

## Пример кода

```python
@router.get("/history/{client_id}")
async def get_dialog_history(
    client_id: int,
    request: Request,
    current_user=Depends(get_current_user),
):
    # Проверка прав
    if not current_user.is_admin and client_id != current_user.id:
        await request.app.state.log.log_warning(
            "dialog", "Попытка доступа к чужому диалогу", {"user": current_user.login, "target": client_id}
        )
        raise HTTPException(status_code=403, detail="Доступ запрещён")

    # Получение истории
    lead = await read_lead_service(client_id, request)
    history_data = json.loads(lead.log) if lead.log else []
    return {"client_id": client_id, "history": history_data}
```

---

## Проверка результата

✅ Обычный пользователь:

* видит **только свой диалог**
* не может получить историю других пользователей

✅ Администратор:

* может просматривать **все** диалоги

✅ Сервер:

* логирует попытки несанкционированного доступа
* корректно возвращает ошибки `401` (если токен невалиден) и `403` (если чужой диалог)

---

## Критерии успешного выполнения

1. Проверка реализована во всех нужных эндпоинтах.
2. Попытка доступа к чужой истории возвращает 403.
3. Админ имеет полный доступ.
4. Логи корректно отражают действия пользователей.
5. Тестирование проводится в Jupyter (`dialog.ipynb`).

## Результат

ДЗ сдать в виде ссылки на архив проекта или GitHub.